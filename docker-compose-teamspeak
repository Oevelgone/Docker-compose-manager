#!/bin/bash

## Include functions file
. $( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )/sharedcontent

## VARIABLES ##

declare -r DEFAULT_TS_VOICE_PORT=9987
declare -r DEFAULT_TS_QUERY_PORT=10011
declare -r DEFAULT_TS_FILE_PORT=30033
declare -r DEFAULT_TS_DNS_PORT=41144
declare -r USAGE_MESSAGE="\$VOICE_PORT (default:9987) {start,stop,restart,up,down,command,logs[teamspeak|db]} [OPTIONS]"

declare -i TS_VOICE_PORT=${DEFAULT_TS_VOICE_PORT}
declare -i TS_QUERY_PORT=${DEFAULT_TS_QUERY_PORT}
declare -i TS_FILE_PORT=${DEFAULT_TS_FILE_PORT}
declare -i TS_DNS_PORT=${DEFAULT_TS_DNS_PORT}
declare -i PORT_DIFF

## PARSING ARGS ##

TS_VOICE_PORT=$1
ACTION=$2
shift 2
ARGS=$@

## FUNCTIONS ##

declare -r DOCKER_CMD="docker-compose -f ${DOCKERCOMPOSE_FILE} -p teamspeak-${TS_VOICE_PORT}"

_start() {
    ${DOCKER_CMD} start ${ARGS}
}

_stop() {
    ${DOCKER_CMD} stop ${ARGS}
}

_up() {
    ${DOCKER_CMD} up ${ARGS}
}

_down() {
    ${DOCKER_CMD} down ${ARGS}
}

_command() {
    ${DOCKER_CMD} ${ARGS}
}

_logs() {
    case $1 in
        teamspeak)
            shift
            ${DOCKER_CMD} logs $@ | grep 'teamspeak_1';;
        db)
            shift
            ${DOCKER_CMD} logs $@ | grep 'db_1';;
        *)
            ${DOCKER_CMD} logs $@;;
    esac
}

_portDiff() {
    isnumber "$TS_VOICE_PORT" && : || _usage
    PORT_DIFF=$(( TS_VOICE_PORT - DEFAULT_TS_VOICE_PORT ))
}

_updatePorts() {
    TS_QUERY_PORT=$(( TS_QUERY_PORT + PORT_DIFF ))
    TS_FILE_PORT=$(( TS_FILE_PORT + PORT_DIFF ))
    TS_DNS_PORT=$(( TS_DNS_PORT + PORT_DIFF ))
}

_exportENV() {
    export TS_VOICE_PORT
    export TS_QUERY_PORT
    export TS_FILE_PORT
    export TS_DNS_PORT
}

## INIT ##

_portDiff && _updatePorts
_exportENV

case $ACTION in
    start)
        _start;;
    stop)
        _stop;;
    restart)
        _stop && _start;;
    up)
        _up;;
    down)
        _down;;
    command)
        _command;;
    logs)
        _logs $ARGS;;
    *)
        _usage;;
esac
