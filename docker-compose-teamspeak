#!/bin/bash

## Include functions file
. ./sharedfunctions

## DEFAULTS VARIABLES ##

declare -r DEFAULT_TS_VOICE_PORT=9987
declare -r DEFAULT_TS_QUERY_PORT=10011
declare -r DEFAULT_TS_FILE_PORT=30033
declare -r DEFAULT_TS_DNS_PORT=41144

## VARIABLES ##

declare -i TS_VOICE_PORT=${DEFAULT_TS_VOICE_PORT}
declare -i TS_QUERY_PORT=${DEFAULT_TS_QUERY_PORT}
declare -i TS_FILE_PORT=${DEFAULT_TS_FILE_PORT}
declare -i TS_DNS_PORT=${DEFAULT_TS_DNS_PORT}
declare -i PORT_DIFF

## PARSING ARGS ##

TS_VOICE_PORT=$1
ACTION=$2
shift 2
ARGS=$@

## FUNCTIONS ##

_start() {
    docker-compose -p teamspeak-${TS_VOICE_PORT} start ${ARGS}
}

_stop() {
    docker-compose -p teamspeak-${TS_VOICE_PORT} stop ${ARGS}
}

_up() {
    docker-compose -p teamspeak-${TS_VOICE_PORT} up ${ARGS}
}

_down() {
    docker-compose -p teamspeak-${TS_VOICE_PORT} down ${ARGS}
}

_portDiff() {
    isnumber "$TS_VOICE_PORT" && : || _usage
    PORT_DIFF=$(( TS_VOICE_PORT - DEFAULT_TS_VOICE_PORT ))
}

_updatePorts() {
    TS_QUERY_PORT=$(( TS_QUERY_PORT + PORT_DIFF ))
    TS_FILE_PORT=$(( TS_FILE_PORT + PORT_DIFF ))
    TS_DNS_PORT=$(( TS_DNS_PORT + PORT_DIFF ))
}

_exportENV() {
    export TS_VOICE_PORT
    export TS_QUERY_PORT
    export TS_FILE_PORT
    export TS_DNS_PORT
}

_usage() {
    echo "Usage : `basename "$0"` \$VOICE_PORT (default:9987) {start,stop,restart,up,down}"
    exit 1
}

## INIT ##

_portDiff && _updatePorts
_exportENV

case $ACTION in
    start)
        _start;;
    stop)
        _stop;;
    restart)
        _stop && _start;;
    up)
        _up;;
    down)
        _down;;
    *)
        _usage;;
esac
